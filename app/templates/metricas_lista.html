{% extends "base.html" %}

{% block title %}M√©tricas{% endblock %}

{% block content %}

<!-- HERO SECTION -->
<section style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white;">
    <div class="container py-4">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="fw-bold mb-2" style="font-size: 2rem; line-height: 1.3;">
                    M√©tricas de Desempe√±o
                </h1>
                <p class="mb-0" style="font-size: 1rem; opacity: 0.9; line-height: 1.6; max-width: 650px;">
                    Indicadores de cumplimiento generados autom√°ticamente desde las incidencias registradas en el sistema
                </p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                {% if session.rol in ['jefe_ti', 'gerente'] %}
                <div class="d-flex flex-column flex-lg-row gap-2 justify-content-lg-end">
                    <button class="btn btn-light" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modalGenerar"
                            style="font-weight: 500;">
                        <i class="fas fa-file-medical me-2"></i>M√©trica Individual
                    </button>
                    
                    <form method="POST" 
                          action="/admin/generar-metricas-ahora" 
                          style="display: inline;" 
                          onsubmit="return confirm('‚ö†Ô∏è GENERACI√ìN MASIVA\n\nSe generar√°n m√©tricas del mes anterior para TODOS los items activos.\n\n¬øDesea continuar?')">
                        <button type="submit" 
                                class="btn w-100" 
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); font-weight: 500;">
                            <i class="fas fa-layer-group me-2"></i>Generar Todas
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- MENSAJES -->
<div class="container-fluid py-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<!-- ESTAD√çSTICAS -->
<section class="py-4" style="background-color: white; border-bottom: 1px solid #e0e0e0;">
    <div class="container-fluid">
        <div class="row text-center g-3">
            <div class="col-md-3 col-6">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-chart-bar fa-2x" style="color: #2c3e50;"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #2c3e50;">{{ total_metricas }}</h3>
                        <p class="text-muted mb-0 small">Total de M√©tricas</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-6">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-success">{{ metricas_verde }}</h3>
                        <p class="text-muted mb-0 small">Estado Verde</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-6">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-warning">{{ metricas_amarillo }}</h3>
                        <p class="text-muted mb-0 small">Estado Amarillo</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-6">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-times-circle fa-2x text-danger"></i>
                        </div>
                        <h3 class="fw-bold mb-1 text-danger">{{ metricas_rojo }}</h3>
                        <p class="text-muted mb-0 small">Estado Rojo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CUMPLIMIENTO PROMEDIO -->
<section class="py-4" style="background-color: #f8f9fa;">
    <div class="container-fluid">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-9">
                        <h5 class="fw-bold mb-3" style="color: #2c3e50;">
                            <i class="fas fa-tachometer-alt me-2"></i>Cumplimiento Promedio General
                        </h5>
                        <div class="progress" style="height: 35px;">
                            <div class="progress-bar {% if cumplimiento_promedio >= 95 %}bg-success{% elif cumplimiento_promedio >= 90 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ cumplimiento_promedio }}%"
                                 aria-valuenow="{{ cumplimiento_promedio }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="fw-bold">{{ cumplimiento_promedio }}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mt-3 mt-md-0">
                        <h1 class="fw-bold mb-1" style="font-size: 3rem; color: #2c3e50;">{{ cumplimiento_promedio }}%</h1>
                        <p class="text-muted mb-0 small">Nivel de Cumplimiento</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FILTROS -->
<section class="py-4" style="background-color: white;">
    <div class="container-fluid">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="mb-3">
                    <h6 class="fw-bold mb-1" style="color: #2c3e50;">
                        <i class="fas fa-filter me-2"></i>Filtros de B√∫squeda
                    </h6>
                    <p class="text-muted mb-0 small">Refine los resultados seg√∫n sus necesidades</p>
                </div>
                
                <form method="GET" action="/metricas" class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label small fw-semibold text-muted">ITEM</label>
                        <select class="form-select" name="item_id">
                            <option value="">Todos los items</option>
                            {% for item in items %}
                            <option value="{{ item.id }}" {% if item_id == item.id|string %}selected{% endif %}>
                                {{ item.codigo }} - {{ item.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label small fw-semibold text-muted">MES</label>
                        <select class="form-select" name="mes">
                            <option value="">Todos</option>
                            {% for m in range(1, 13) %}
                            <option value="{{ m }}" {% if mes == m|string %}selected{% endif %}>
                                {{ ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m-1] }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label small fw-semibold text-muted">A√ëO</label>
                        <select class="form-select" name="anio">
                            <option value="">Todos</option>
                            {% for a in range(2025, 2020, -1) %}
                            <option value="{{ a }}" {% if anio == a|string %}selected{% endif %}>{{ a }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label small fw-semibold text-muted">ESTADO</label>
                        <select class="form-select" name="semaforo">
                            <option value="">Todos los estados</option>
                            <option value="verde" {% if semaforo == 'verde' %}selected{% endif %}>‚úì Verde (√ìptimo)</option>
                            <option value="amarillo" {% if semaforo == 'amarillo' %}selected{% endif %}>‚ö† Amarillo (Advertencia)</option>
                            <option value="rojo" {% if semaforo == 'rojo' %}selected{% endif %}>‚úó Rojo (Cr√≠tico)</option>
                        </select>
                    </div>
                    
                    <div class="col-lg-2 col-md-12 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1" style="background: #2c3e50; border: none; font-weight: 500;">
                            <i class="fas fa-search me-1"></i>Buscar
                        </button>
                        <a href="/metricas" class="btn btn-outline-secondary">
                            <i class="fas fa-redo"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- TABLA -->
<section class="py-4" style="background-color: #f8f9fa;">
    <div class="container-fluid">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                {% if metricas %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <tr>
                                <th class="fw-semibold text-muted py-3 px-4">PER√çODO</th>
                                <th class="fw-semibold text-muted py-3">ITEM</th>
                                <th class="fw-semibold text-muted py-3">TIPO</th>
                                <th class="fw-semibold text-muted py-3 text-center">INCIDENCIAS</th>
                                <th class="fw-semibold text-muted py-3">CUMPLIMIENTO</th>
                                <th class="fw-semibold text-muted py-3 text-center">ESTADO</th>
                                <th class="fw-semibold text-muted py-3 text-center">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in metricas %}
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td class="px-4 py-3">
                                    <span class="fw-semibold" style="color: #2c3e50;">
                                        {{ ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][data.metrica.mes-1] }} {{ data.metrica.anio }}
                                    </span>
                                </td>
                                <td class="py-3">
                                    <div>
                                        <span class="fw-bold d-block" style="color: #2c3e50;">{{ data.item.codigo }}</span>
                                        <small class="text-muted">{{ data.item.nombre }}</small>
                                    </div>
                                </td>
                                <td class="py-3">
                                    <span class="badge px-3 py-2" style="{% if data.item.tipo == 'producto' %}background-color: #e67e22; color: white;{% else %}background-color: #27ae60; color: white;{% endif %}">
                                        {{ data.item.tipo|upper }}
                                    </span>
                                </td>
                                <td class="text-center py-3">
                                    {% if data.metrica.incidencias == 0 %}
                                    <span class="badge bg-success px-3 py-2">0</span>
                                    {% elif data.metrica.incidencias <= 2 %}
                                    <span class="badge bg-warning px-3 py-2">{{ data.metrica.incidencias }}</span>
                                    {% else %}
                                    <span class="badge bg-danger px-3 py-2">{{ data.metrica.incidencias }}</span>
                                    {% endif %}
                                </td>
                                <td class="py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-3" style="height: 10px; width: 120px;">
                                            <div class="progress-bar 
                                                {% if data.metrica.semaforo == 'verde' %}bg-success
                                                {% elif data.metrica.semaforo == 'amarillo' %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                style="width: {{ data.metrica.porcentaje_cumplimiento }}%"></div>
                                        </div>
                                        <span class="fw-bold" style="color: #2c3e50;">{{ data.metrica.porcentaje_cumplimiento }}%</span>
                                    </div>
                                </td>
                                <td class="text-center py-3">
                                    {% if data.metrica.semaforo == 'verde' %}
                                    <span class="badge bg-success px-3 py-2">
                                        <i class="fas fa-check-circle me-1"></i>VERDE
                                    </span>
                                    {% elif data.metrica.semaforo == 'amarillo' %}
                                    <span class="badge bg-warning px-3 py-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>AMARILLO
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger px-3 py-2">
                                        <i class="fas fa-times-circle me-1"></i>ROJO
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="text-center py-3">
                                    {% if session.rol in ['jefe_ti', 'gerente'] %}
                                    <div class="d-flex gap-1 justify-content-center">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="recalcularMetrica({{ data.metrica.id }})"
                                                title="Recalcular m√©trica">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="eliminarMetrica({{ data.metrica.id }})"
                                                title="Eliminar m√©trica">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-chart-bar fa-4x text-muted opacity-50"></i>
                    </div>
                    <h5 class="fw-bold mb-2" style="color: #2c3e50;">No hay m√©tricas registradas</h5>
                    <p class="text-muted mb-3">Las m√©tricas se generan autom√°ticamente el primer d√≠a de cada mes</p>
                    <p class="text-muted small mb-4">Tambi√©n puede generar m√©tricas manualmente desde los botones superiores</p>
                    {% if session.rol in ['jefe_ti', 'gerente'] %}
                    <button class="btn px-4 py-2" 
                            style="background: #2c3e50; color: white; border: none; font-weight: 500;"
                            data-bs-toggle="modal" 
                            data-bs-target="#modalGenerar">
                        <i class="fas fa-plus-circle me-2"></i>Generar Primera M√©trica
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- MODAL: GENERAR M√âTRICA INDIVIDUAL -->
<div class="modal fade" id="modalGenerar" tabindex="-1" aria-labelledby="modalGenerarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px; overflow: hidden;">
            
            <!-- Header -->
            <div class="modal-header border-0 py-4" style="background: #2c3e50; color: white;">
                <div>
                    <h5 class="modal-title fw-bold mb-1" id="modalGenerarLabel">
                        <i class="fas fa-chart-line me-2"></i>Generar M√©trica Individual
                    </h5>
                    <p class="mb-0 small" style="opacity: 0.9;">
                        C√°lculo autom√°tico del cumplimiento SLA basado en incidencias
                    </p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Body -->
            <div class="modal-body p-4" style="background: #f8f9fa;">
                
                <!-- Info Box -->
                <div class="alert border-0 mb-4" style="background-color: #fff; border-left: 4px solid #2c3e50 !important;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-3 mt-1" style="color: #2c3e50; font-size: 18px;"></i>
                        <div>
                            <p class="mb-1" style="color: #2c3e50; font-weight: 500; font-size: 14px;">
                                ¬øC√≥mo funciona?
                            </p>
                            <p class="mb-0 text-muted small" style="line-height: 1.6;">
                                El sistema cuenta autom√°ticamente las incidencias registradas en el mes seleccionado 
                                y calcula el porcentaje de cumplimiento del SLA del item elegido.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Formulario -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        
                        <!-- Selector de Item con B√∫squeda -->
                        <div class="mb-4">
                            <label class="form-label fw-bold mb-3" style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-cube me-2"></i>Producto o Servicio
                                <span class="text-danger">*</span>
                            </label>
                            
                            <!-- Input de B√∫squeda -->
                            <input type="text" 
                                   class="form-control mb-3" 
                                   id="buscarItem" 
                                   placeholder="üîç Escriba c√≥digo, nombre o categor√≠a para buscar..."
                                   style="height: 50px; font-size: 15px; border: 2px solid #dee2e6;"
                                   autocomplete="off">
                            
                            <!-- Contenedor de Resultados -->
                            <div id="resultadosItems" style="max-height: 300px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 8px; background: white; display: none;">
                                <!-- Los resultados se cargan din√°micamente -->
                            </div>
                            
                            <!-- Item Seleccionado -->
                            <div id="itemSeleccionado" style="display: none;" class="mt-3 p-3 rounded" style="background: #e3f2fd; border: 2px solid #2196f3;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong style="color: #2c3e50;">Seleccionado:</strong> 
                                        <span id="itemSeleccionadoTexto" style="color: #1976d2;"></span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarSeleccion()">
                                        <i class="fas fa-times me-1"></i> Cambiar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Input Oculto con el ID -->
                            <input type="hidden" id="itemIdHidden" value="">
                            
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-search me-1"></i>
                                Escriba para filtrar: c√≥digo, nombre o categor√≠a
                            </small>
                        </div>

                        <hr class="my-4">
                        
                        <!-- Per√≠odo -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-2" style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-calendar-alt me-2"></i>Mes
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="mesSelect" required style="height: 50px; font-size: 15px;">
                                    {% for m in range(1, 13) %}
                                    <option value="{{ m }}">
                                        {{ ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m-1] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-2" style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-calendar me-2"></i>A√±o
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="anioInput" 
                                       value="2025" 
                                       min="2020" 
                                       max="2030" 
                                       required
                                       style="height: 50px; font-size: 15px;">
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Nota de Uso -->
                <div class="mt-3 p-3" style="background-color: #fffbf0; border-radius: 8px; border: 1px solid #ffeaa7;">
                    <small class="text-muted d-flex align-items-start" style="line-height: 1.6;">
                        <i class="fas fa-lightbulb me-2 mt-1" style="color: #f39c12;"></i>
                        <span>
                            <strong style="color: #2c3e50;">Casos de uso comunes:</strong> 
                            Meses olvidados, correcci√≥n de datos err√≥neos, items agregados despu√©s del cierre mensual, 
                            regeneraci√≥n por cambios en configuraci√≥n de SLA.
                        </span>
                    </small>
                </div>
                
            </div>
            
            <!-- Footer -->
            <div class="modal-footer border-0" style="background: #fff; padding: 20px 24px;">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal" style="font-weight: 500; border: 2px solid #dee2e6;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn px-4 py-2" onclick="generarMetrica()" style="background: #2c3e50; color: white; border: none; font-weight: 500;">
                    <i class="fas fa-check-circle me-2"></i>Generar M√©trica
                </button>
            </div>
            
        </div>
    </div>
</div>

<style>
/* Estilos para el buscador personalizado */
.item-resultado {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
}

.item-resultado:hover {
    background-color: #f8f9fa;
}

.item-resultado:last-child {
    border-bottom: none;
}

.item-codigo {
    font-weight: 600;
    color: #2c3e50;
    font-size: 15px;
    font-family: 'Courier New', monospace;
}

.item-nombre {
    color: #495057;
    font-size: 13px;
    margin-top: 4px;
}

.item-badges {
    display: flex;
    gap: 6px;
    margin-top: 6px;
}

.item-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-producto-custom {
    background-color: #e3f2fd;
    color: #1976d2;
}

.badge-servicio-custom {
    background-color: #e8f5e9;
    color: #388e3c;
}

.badge-categoria-custom {
    background-color: #f5f5f5;
    color: #616161;
}
</style>

<script>
// ========================================
// DATOS DE ITEMS (desde servidor)
// ========================================
const todosLosItems = [
    {% for item in items %}
    {
        id: {{ item.id }},
        codigo: '{{ item.codigo }}',
        nombre: '{{ item.nombre }}',
        tipo: '{{ item.tipo }}',
        categoria: '{{ item.categoria or '' }}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// ========================================
// B√öSQUEDA Y FILTRADO
// ========================================
const inputBuscar = document.getElementById('buscarItem');
const contenedorResultados = document.getElementById('resultadosItems');
const itemSeleccionadoDiv = document.getElementById('itemSeleccionado');
const itemSeleccionadoTexto = document.getElementById('itemSeleccionadoTexto');
const itemIdHidden = document.getElementById('itemIdHidden');

// Evento de b√∫squeda
inputBuscar.addEventListener('input', function() {
    const termino = this.value.toLowerCase().trim();
    
    if (termino.length === 0) {
        contenedorResultados.style.display = 'none';
        contenedorResultados.innerHTML = '';
        return;
    }
    
    // Filtrar items
    const resultados = todosLosItems.filter(item => {
        return item.codigo.toLowerCase().includes(termino) ||
               item.nombre.toLowerCase().includes(termino) ||
               item.tipo.toLowerCase().includes(termino) ||
               item.categoria.toLowerCase().includes(termino);
    });
    
    // Mostrar resultados
    mostrarResultados(resultados);
});

function mostrarResultados(resultados) {
    if (resultados.length === 0) {
        contenedorResultados.innerHTML = '<div class="p-3 text-center text-muted">No se encontraron resultados</div>';
        contenedorResultados.style.display = 'block';
        return;
    }
    
    let html = '';
    resultados.forEach(item => {
        const icono = item.tipo === 'producto' ? 'üì¶' : '‚öôÔ∏è';
        const badgeTipo = item.tipo === 'producto' 
            ? '<span class="item-badge badge-producto-custom">Producto</span>'
            : '<span class="item-badge badge-servicio-custom">Servicio</span>';
        const badgeCategoria = item.categoria 
            ? `<span class="item-badge badge-categoria-custom">${item.categoria}</span>`
            : '';
        
        html += `
            <div class="item-resultado" onclick="seleccionarItem(${item.id}, '${item.codigo}', '${item.nombre}', '${item.tipo}')">
                <div class="item-codigo">${icono} ${item.codigo}</div>
                <div class="item-nombre">${item.nombre}</div>
                <div class="item-badges">
                    ${badgeTipo}
                    ${badgeCategoria}
                </div>
            </div>
        `;
    });
    
    contenedorResultados.innerHTML = html;
    contenedorResultados.style.display = 'block';
}

function seleccionarItem(id, codigo, nombre, tipo) {
    // Guardar selecci√≥n
    itemIdHidden.value = id;
    
    const icono = tipo === 'producto' ? 'üì¶' : '‚öôÔ∏è';
    itemSeleccionadoTexto.textContent = `${icono} ${codigo} - ${nombre}`;
    
    // Mostrar selecci√≥n
    itemSeleccionadoDiv.style.display = 'block';
    
    // Ocultar resultados
    contenedorResultados.style.display = 'none';
    contenedorResultados.innerHTML = '';
    
    // Limpiar input
    inputBuscar.value = '';
}

function limpiarSeleccion() {
    itemIdHidden.value = '';
    itemSeleccionadoDiv.style.display = 'none';
    inputBuscar.value = '';
    inputBuscar.focus();
}

// ========================================
// GENERAR M√âTRICA
// ========================================
function generarMetrica() {
    const itemId = itemIdHidden.value;
    const mes = document.getElementById('mesSelect').value;
    const anio = document.getElementById('anioInput').value;
    
    if (!itemId || !mes || !anio) {
        alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios');
        return;
    }
    
    // Mostrar loading
    const btnGenerar = event.target;
    const textoOriginal = btnGenerar.innerHTML;
    btnGenerar.disabled = true;
    btnGenerar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
    
    fetch(`/metricas/generar-automatico/${itemId}/${mes}/${anio}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ M√âTRICA GENERADA EXITOSAMENTE\n\nüìä Incidencias: ${data.incidencias}\nüö¶ Estado: ${data.semaforo.toUpperCase()}\nüìà Cumplimiento: ${data.porcentaje_cumplimiento}%`);
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
            btnGenerar.disabled = false;
            btnGenerar.innerHTML = textoOriginal;
        }
    })
    .catch(error => {
        alert('‚ùå Error de conexi√≥n: ' + error);
        btnGenerar.disabled = false;
        btnGenerar.innerHTML = textoOriginal;
    });
}

function eliminarMetrica(metricaId) {
    if (!confirm('‚ö†Ô∏è ¬øEst√° seguro que desea eliminar esta m√©trica?\n\nEsta acci√≥n no se puede deshacer.')) return;
    
    fetch(`/metricas/${metricaId}/eliminar`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ M√©trica eliminada correctamente');
            location.reload();
        } else {
            alert('‚ùå Error al eliminar la m√©trica');
        }
    })
    .catch(error => {
        alert('‚ùå Error de conexi√≥n: ' + error);
    });
}

function recalcularMetrica(metricaId) {
    if (!confirm('üîÑ RECALCULAR M√âTRICA\n\nSe contar√°n las incidencias actuales del per√≠odo y se actualizar√° el porcentaje de cumplimiento.\n\n¬øDesea continuar?')) return;
    
    fetch(`/metricas/recalcular/${metricaId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ M√âTRICA RECALCULADA\n\nüìä Incidencias: ${data.incidencias}\nüö¶ Estado: ${data.semaforo.toUpperCase()}\nüìà Cumplimiento: ${data.porcentaje_cumplimiento}%`);
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Error de conexi√≥n: ' + error);
    });
}

// Limpiar al cerrar modal
document.getElementById('modalGenerar').addEventListener('hidden.bs.modal', function() {
    limpiarSeleccion();
});
</script>

{% endblock %}