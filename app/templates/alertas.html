{% extends "base.html" %}

{% block title %}Alertas{% endblock %}

{% block content %}

<!-- HERO SECTION -->
<section style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white;">
    <div class="container py-5">
        <div class="row align-items-center" style="min-height: 280px;">
            <div class="col-lg-8">
                <h1 class="fw-bold mb-3" style="font-size: 2.2rem; line-height: 1.3;">
                    Gestión de Alertas del Sistema
                </h1>
                <p class="mb-4" style="font-size: 1.1rem; opacity: 0.9; line-height: 1.6; max-width: 650px;">
                    Sistema de alertas automáticas para el seguimiento de cumplimiento de SLAs, monitoreo de incidencias y control de estados críticos del portafolio tecnológico.
                </p>
                <div class="d-flex gap-3 flex-wrap">
                    <a href="/dashboard" class="btn btn-light px-4 py-2" style="font-weight: 500;">
                        Volver al Dashboard
                    </a>
                    <a href="/incidencias" class="btn px-4 py-2" style="background: transparent; color: white; font-weight: 500; border: 1px solid rgba(255,255,255,0.5);">
                        Ver Incidencias
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ESTADÍSTICAS -->
<section class="py-4" style="background-color: white; border-bottom: 1px solid #e0e0e0;">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-3 mb-md-0">
                <h3 class="fw-bold mb-1 text-danger">{{ alertas_criticas }}</h3>
                <p class="text-muted mb-0 small">Críticas Activas</p>
            </div>
            <div class="col-md-3 col-6 mb-3 mb-md-0">
                <h3 class="fw-bold mb-1 text-warning">{{ alertas_altas }}</h3>
                <p class="text-muted mb-0 small">Altas Activas</p>
            </div>
            <div class="col-md-3 col-6">
                <h3 class="fw-bold mb-1 text-info">{{ alertas_activas }}</h3>
                <p class="text-muted mb-0 small">Total Activas</p>
            </div>
            <div class="col-md-3 col-6">
                <h3 class="fw-bold mb-1 text-success">{{ alertas_resueltas }}</h3>
                <p class="text-muted mb-0 small">Resueltas</p>
            </div>
        </div>
    </div>
</section>

<!-- CONTENIDO PRINCIPAL -->
<section class="py-5" style="background-color: #f8f9fa;">
    <div class="container">
        <div class="row g-4">
            
            <!-- FILTROS -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm sticky-top" style="top: 90px; border-left: 3px solid #2c3e50;">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-4" style="color: #2c3e50;">Filtros de Búsqueda</h6>
                        
                        <form method="GET" action="/alertas">
                            <!-- Estado -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold small" style="color: #2c3e50;">Estado</label>
                                <select class="form-select" name="estado" onchange="this.form.submit()" style="border: 1px solid #dee2e6;">
                                    <option value="" {% if not estado_filtro %}selected{% endif %}>Todas</option>
                                    <option value="activa" {% if estado_filtro == 'activa' %}selected{% endif %}>Activas</option>
                                    <option value="resuelta" {% if estado_filtro == 'resuelta' %}selected{% endif %}>Resueltas</option>
                                </select>
                            </div>

                            <!-- Urgencia -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold small" style="color: #2c3e50;">Nivel de Urgencia</label>
                                <select class="form-select" name="urgencia" onchange="this.form.submit()" style="border: 1px solid #dee2e6;">
                                    <option value="" {% if not urgencia_filtro %}selected{% endif %}>Todas</option>
                                    <option value="critica" {% if urgencia_filtro == 'critica' %}selected{% endif %}>Crítica</option>
                                    <option value="alta" {% if urgencia_filtro == 'alta' %}selected{% endif %}>Alta</option>
                                    <option value="media" {% if urgencia_filtro == 'media' %}selected{% endif %}>Media</option>
                                    <option value="baja" {% if urgencia_filtro == 'baja' %}selected{% endif %}>Baja</option>
                                </select>
                            </div>

                            <!-- Tipo -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold small" style="color: #2c3e50;">Tipo de Alerta</label>
                                <select class="form-select" name="tipo" onchange="this.form.submit()" style="border: 1px solid #dee2e6;">
                                    <option value="" {% if not tipo_filtro %}selected{% endif %}>Todos</option>
                                    <option value="sobrepaso_sla" {% if tipo_filtro == 'sobrepaso_sla' %}selected{% endif %}>Sobrepaso SLA</option>
                                    <option value="alerta_manual_critica" {% if tipo_filtro == 'alerta_manual_critica' %}selected{% endif %}>Alerta Manual</option>
                                    <option value="rojo_inmediato" {% if tipo_filtro == 'rojo_inmediato' %}selected{% endif %}>Rojo Inmediato</option>
                                    <option value="amarillo_recurrente" {% if tipo_filtro == 'amarillo_recurrente' %}selected{% endif %}>Amarillo Recurrente</option>
                                    <option value="rojo_mes2" {% if tipo_filtro == 'rojo_mes2' %}selected{% endif %}>Rojo 2 Meses</option>
                                    <option value="rojo_mes3" {% if tipo_filtro == 'rojo_mes3' %}selected{% endif %}>Rojo 3 Meses</option>
                                    <option value="incidencias_masivas" {% if tipo_filtro == 'incidencias_masivas' %}selected{% endif %}>Incidencias Masivas</option>
                                    <option value="reemplazo" {% if tipo_filtro == 'reemplazo' %}selected{% endif %}>Reemplazo</option>
                                </select>
                            </div>

                            <a href="/alertas" class="text-decoration-none small d-block text-center py-2" style="color: #2c3e50; font-weight: 500; border: 1px solid #dee2e6; border-radius: 4px;">
                                Limpiar Filtros →
                            </a>
                        </form>
                    </div>
                </div>
            </div>

            <!-- LISTA DE ALERTAS -->
            <div class="col-lg-9">
                
                <div class="mb-4">
                    <h2 class="fw-bold mb-2" style="color: #2c3e50; font-size: 1.75rem;">Alertas Registradas</h2>
                    <p class="text-muted mb-0">Seguimiento de alertas del sistema de gestión de portafolio TI</p>
                </div>

                {% if alertas %}
                <div class="row g-3">
                    {% for data in alertas %}
                    <div class="col-12">
                        <div class="card h-100 border-0 shadow-sm" 
                             style="border-left: 3px solid 
                             {% if data.alerta.nivel_urgencia == 'critica' %}#dc3545
                             {% elif data.alerta.nivel_urgencia == 'alta' %}#ffc107
                             {% elif data.alerta.nivel_urgencia == 'media' %}#17a2b8
                             {% else %}#28a745{% endif %};">
                            <div class="card-body p-4">
                                <div class="row align-items-start g-3">
                                    
                                    <!-- Información Principal -->
                                    <div class="col-lg-8">
                                        <!-- Badges superiores -->
                                        <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
                                            <span class="badge" 
                                                  style="background-color: 
                                                  {% if data.alerta.nivel_urgencia == 'critica' %}#dc3545
                                                  {% elif data.alerta.nivel_urgencia == 'alta' %}#ffc107
                                                  {% elif data.alerta.nivel_urgencia == 'media' %}#17a2b8
                                                  {% else %}#28a745{% endif %}; 
                                                  color: {% if data.alerta.nivel_urgencia == 'alta' %}#000{% else %}white{% endif %};">
                                                {{ data.alerta.nivel_urgencia|upper }}
                                            </span>
                                            <span class="badge {% if data.alerta.estado == 'activa' %}bg-secondary{% else %}bg-success{% endif %}">
                                                {{ data.alerta.estado|upper }}
                                            </span>
                                        </div>

                                        <!-- Producto/Servicio -->
                                        <h6 class="fw-bold mb-2" style="color: #2c3e50;">
                                            <span class="badge me-2" style="background-color: {% if data.item.tipo == 'producto' %}#007bff{% else %}#28a745{% endif %}; color: white;">
                                                {{ data.item.codigo }}
                                            </span>
                                            {{ data.item.nombre }}
                                        </h6>

                                        <!-- Mensaje -->
                                        <p class="text-muted mb-3 small" style="line-height: 1.6;">
                                            {{ data.alerta.mensaje }}
                                        </p>

                                        <!-- Progreso (solo sobrepaso SLA) -->
                                        {% if data.alerta.tipo == 'sobrepaso_sla' and data.alerta.incidencias_pendientes > 0 %}
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-2">
                                                <strong>Progreso:</strong> {{ data.alerta.incidencias_resueltas_count }}/{{ data.alerta.incidencias_pendientes }} incidencias resueltas
                                            </small>
                                            <div class="progress" style="height: 8px; border-radius: 4px; background-color: #e9ecef;">
                                                <div class="progress-bar {% if data.alerta.estado == 'resuelta' %}bg-success{% else %}bg-primary{% endif %}" 
                                                     role="progressbar"
                                                     style="width: {{ (data.alerta.incidencias_resueltas_count / data.alerta.incidencias_pendientes * 100) if data.alerta.incidencias_pendientes > 0 else 0 }}%"></div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Fechas -->
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <strong>Creada:</strong> {{ data.alerta.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                                                </small>
                                            </div>
                                            {% if data.alerta.fecha_resolucion %}
                                            <div class="col-md-6">
                                                <small class="text-success">
                                                    <strong>Resuelta:</strong> {{ data.alerta.fecha_resolucion.strftime('%d/%m/%Y %H:%M') }}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Tipo de alerta -->
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <strong>Tipo:</strong> {{ data.alerta.tipo.replace('_', ' ')|title }}
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Acciones -->
                                    <div class="col-lg-4 text-lg-end">
                                        <div class="d-flex flex-column gap-2">
                                            <a href="/{{ 'producto' if data.item.tipo == 'producto' else 'servicio' }}/{{ data.item.id }}" 
                                               class="text-decoration-none small text-center py-2" 
                                               target="_blank"
                                               style="color: #2c3e50; font-weight: 500; border: 1px solid #dee2e6; border-radius: 4px;">
                                                Ver Item →
                                            </a>
                                            
                                            {% if data.alerta.estado == 'activa' and session.rol in ['jefe_ti', 'gerente'] %}
                                                {% if data.alerta.tipo == 'sobrepaso_sla' %}
                                                <button class="btn px-3 py-2 small" 
                                                        onclick="abrirModalResolverAlerta({{ data.alerta.id }})" 
                                                        style="background: #28a745; color: white; border: none; font-weight: 500;">
                                                    Resolver Alerta
                                                </button>
                                                {% else %}
                                                <button class="btn px-3 py-2 small" 
                                                        onclick="resolverAlertaDirecto({{ data.alerta.id }})" 
                                                        style="background: #28a745; color: white; border: none; font-weight: 500;">
                                                    Resolver Alerta
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <!-- ESTADO VACÍO -->
                <div class="card border-0 shadow-sm" style="border-left: 3px solid #2c3e50;">
                    <div class="card-body p-5 text-center">
                        <div class="mb-4" style="opacity: 0.3;">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </div>
                        <h5 class="fw-bold mb-2" style="color: #2c3e50;">No se encontraron alertas</h5>
                        <p class="text-muted mb-3" style="line-height: 1.6;">
                            {% if estado_filtro or tipo_filtro or urgencia_filtro %}
                            No hay alertas que coincidan con los filtros seleccionados. Intente ajustar los criterios de búsqueda.
                            {% else %}
                            No hay alertas registradas en el sistema actualmente. Todas las operaciones están dentro de los parámetros normales.
                            {% endif %}
                        </p>
                        {% if estado_filtro or tipo_filtro or urgencia_filtro %}
                        <a href="/alertas" class="text-decoration-none small" style="color: #2c3e50; font-weight: 500;">
                            Ver todas las alertas →
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</section>

<!-- MODAL: Resolver Alerta - Selección -->
<div class="modal fade" id="modalResolverAlerta" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header py-3" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border: none;">
                <h5 class="modal-title fw-bold">Resolver Alerta - Seleccionar Incidencias</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Info del Item -->
                <div class="alert border-0 mb-3" style="background-color: #e3f2fd; border-left: 3px solid #2196f3 !important;">
                    <div class="d-flex align-items-start">
                        <div class="me-3" style="color: #2196f3;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                        </div>
                        <div>
                            <strong id="modalItemInfo" class="d-block mb-1" style="color: #2c3e50;"></strong>
                            <small id="modalItemLimite" class="text-muted"></small>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="modalLoading" class="text-center py-4">
                    <div class="spinner-border mb-3" style="color: #2c3e50;" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="text-muted mb-0 small">Cargando incidencias...</p>
                </div>

                <!-- Lista de Incidencias -->
                <div id="modalIncidencias" style="display: none;">
                    <p class="text-muted mb-3 small" style="line-height: 1.6;">
                        Seleccione las incidencias que desea resolver. Para cada una deberá proporcionar una imagen de prueba y comentario.
                    </p>
                    <div id="listaIncidencias" class="border rounded" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        <!-- Dinámico con JavaScript -->
                    </div>
                    <div id="noIncidencias" class="alert border-0 mt-3" style="display: none; background-color: #fff3cd; border-left: 3px solid #ffc107 !important;">
                        <small class="text-muted">No hay incidencias activas para resolver.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top py-3">
                <button type="button" class="btn px-4 py-2" data-bs-dismiss="modal" style="background: transparent; color: #2c3e50; border: 1px solid #dee2e6; font-weight: 500;">
                    Cancelar
                </button>
                <button type="button" class="btn px-4 py-2" onclick="resolverIncidenciasSeleccionadas()" style="background: #28a745; color: white; border: none; font-weight: 500;">
                    Continuar con Resolución
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Resolver Incidencia Individual -->
<div class="modal fade" id="modalResolverIncidenciaAlerta" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px; overflow: hidden;">
            
            <div class="modal-header border-0 py-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                <div>
                    <h5 class="modal-title fw-bold mb-1">
                        <i class="fas fa-check-circle me-2"></i>Resolver Incidencia <span id="modalIncActualNum"></span>
                    </h5>
                    <p class="mb-0 small" style="opacity: 0.9;">
                        Complete la información para marcar como resuelta
                    </p>
                </div>
                <button type="button" class="btn-close btn-close-white" onclick="cancelarResolucionIncidencia()"></button>
            </div>
            
            <div class="modal-body p-4" style="background: #f8f9fa;">
                
                <div class="alert border-0 mb-4" style="background-color: #e3f2fd; border-left: 4px solid #2196f3 !important;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-user-check me-3 mt-1" style="color: #2196f3; font-size: 20px;"></i>
                        <div>
                            <p class="mb-1" style="color: #2c3e50; font-weight: 600; font-size: 14px;">
                                Resolviendo como: <span id="nombreUsuarioActualAlerta" style="color: #1976d2;"></span>
                            </p>
                            <small style="color: #546e7a;">
                                Esta acción quedará registrada en el sistema
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <label class="small fw-semibold text-muted">INCIDENCIA</label>
                            <p class="fw-semibold mb-1" style="color: #2c3e50;" id="modalIncTitulo"></p>
                            <small class="text-muted" id="modalIncItem"></small>
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <small class="text-muted d-block">Tipo</small>
                                <span id="modalIncTipo" class="badge"></span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Severidad</small>
                                <span id="modalIncSeveridad" class="badge"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold mb-2" style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-comment-dots me-2"></i>Comentario de Resolución
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" 
                                      id="comentarioResolucionAlerta" 
                                      rows="4" 
                                      placeholder="Describa detalladamente las acciones realizadas para resolver la incidencia..."
                                      style="font-size: 15px; border: 2px solid #dee2e6;"
                                      required></textarea>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Mínimo 10 caracteres. Sea específico sobre la solución aplicada.
                            </small>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label class="form-label fw-bold mb-2" style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-camera me-2"></i>Imagen de Prueba
                                <span class="text-danger">*</span>
                            </label>
                            
                            <input type="file" 
                                   class="form-control" 
                                   id="imagenPruebaAlerta" 
                                   accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
                                   style="height: 50px; font-size: 15px; border: 2px solid #dee2e6;"
                                   required>
                            
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-image me-1"></i>
                                Formatos: PNG, JPG, JPEG, GIF, WEBP (Máx. 5MB)
                            </small>
                        </div>

                        <div id="imagePreviewAlerta" class="mt-3 text-center p-3" style="display: none; background: white; border-radius: 8px;">
                            <small class="text-muted d-block mb-2">Vista previa:</small>
                            <img id="previewImgAlerta" src="" style="max-width: 100%; max-height: 250px; border-radius: 8px; border: 2px solid #dee2e6; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>

                <div id="errorMensajeAlerta" class="alert alert-danger mt-3 border-0" style="display: none; border-left: 4px solid #dc3545 !important;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorTextoAlerta"></span>
                </div>
            </div>
            
            <div class="modal-footer border-0 py-3" style="background: #fff;">
                <button type="button" class="btn btn-light px-4 py-2" onclick="cancelarResolucionIncidencia()" style="font-weight: 500; border: 2px solid #dee2e6;">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success px-4 py-2" onclick="confirmarResolucionIncidenciaAlerta()" style="font-weight: 500;">
                    <i class="fas fa-check-circle me-1"></i>Marcar como Resuelta
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let alertaIdActual = null;
let incidenciasSeleccionadas = [];
let incidenciaActualIndex = 0;
let datosIncidencias = [];

// Cargar nombre del usuario actual
let nombreCompletoUsuario = '{{ session.username }}';

fetch('/api/usuario-actual-info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nombreCompletoUsuario = data.nombre_completo;
        }
    })
    .catch(error => console.error('Error al cargar info usuario:', error));

function abrirModalResolverAlerta(alertaId) {
    alertaIdActual = alertaId;
    const modal = new bootstrap.Modal(document.getElementById('modalResolverAlerta'));
    
    document.getElementById('modalLoading').style.display = 'block';
    document.getElementById('modalIncidencias').style.display = 'none';
    
    modal.show();
    
    fetch(`/alerta/${alertaId}/incidencias`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalLoading').style.display = 'none';
            
            if (data.success) {
                document.getElementById('modalItemInfo').textContent = 
                    `${data.item.codigo} - ${data.item.nombre}`;
                document.getElementById('modalItemLimite').textContent = 
                    `Límite SLA: ${data.item.limite_sla} incidencias mensuales | Activas: ${data.total_activas} | Resueltas: ${data.total_resueltas}`;
                
                document.getElementById('modalIncidencias').style.display = 'block';
                
                // Filtrar solo incidencias NO resueltas
                const incidenciasNoResueltas = data.incidencias.filter(inc => !inc.ya_resuelta);
                
                if (incidenciasNoResueltas.length === 0) {
                    document.getElementById('noIncidencias').style.display = 'block';
                    document.getElementById('listaIncidencias').innerHTML = '';
                } else {
                    document.getElementById('noIncidencias').style.display = 'none';
                    mostrarIncidencias(incidenciasNoResueltas);
                    datosIncidencias = incidenciasNoResueltas;
                }
            } else {
                alert('Error al cargar incidencias: ' + data.error);
                modal.hide();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al cargar incidencias');
            modal.hide();
        });
}

function mostrarIncidencias(incidencias) {
    const lista = document.getElementById('listaIncidencias');
    lista.innerHTML = '';
    
    const severidadColor = {
        'critica': '#dc3545',
        'alta': '#ffc107',
        'media': '#17a2b8',
        'baja': '#28a745'
    };
    
    incidencias.forEach((inc, index) => {
        const item = document.createElement('div');
        item.className = `p-3 ${index < incidencias.length - 1 ? 'border-bottom' : ''}`;
        item.style.backgroundColor = 'white';
        
        item.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="form-check me-3 mt-1">
                    <input class="form-check-input" type="checkbox" value="${inc.id}" 
                           id="inc${inc.id}" data-index="${index}">
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                        <h6 class="mb-0 fw-bold small" style="color: #2c3e50;">${inc.titulo}</h6>
                        <span class="badge" style="background-color: ${severidadColor[inc.severidad]}; color: ${inc.severidad === 'alta' ? '#000' : 'white'};">
                            ${inc.severidad.toUpperCase()}
                        </span>
                    </div>
                    <p class="mb-2 small text-muted" style="line-height: 1.6;">${inc.descripcion}</p>
                    <div class="small text-muted">
                        <strong>Fecha:</strong> ${inc.fecha_incidencia} | 
                        <strong>Usuarios:</strong> ${inc.usuarios_afectados} | 
                        <strong>Tipo:</strong> ${inc.tipo}
                    </div>
                </div>
            </div>
        `;
        
        lista.appendChild(item);
    });
}

function resolverIncidenciasSeleccionadas() {
    const checkboxes = document.querySelectorAll('#listaIncidencias input[type="checkbox"]:checked');
    incidenciasSeleccionadas = [];
    
    checkboxes.forEach(cb => {
        const incId = parseInt(cb.value);
        const incIndex = parseInt(cb.getAttribute('data-index'));
        incidenciasSeleccionadas.push({
            id: incId,
            data: datosIncidencias[incIndex]
        });
    });
    
    if (incidenciasSeleccionadas.length === 0) {
        if (!confirm('No ha seleccionado ninguna incidencia. ¿Desea resolver la alerta manualmente sin resolver incidencias?')) {
            return;
        }
        resolverAlertaSinIncidencias();
        return;
    }
    
    // Cerrar modal de selección y abrir modal de resolución
    bootstrap.Modal.getInstance(document.getElementById('modalResolverAlerta')).hide();
    
    incidenciaActualIndex = 0;
    abrirModalResolucionIncidencia();
}

function abrirModalResolucionIncidencia() {
    const inc = incidenciasSeleccionadas[incidenciaActualIndex];
    
    document.getElementById('modalIncActualNum').textContent = `(${incidenciaActualIndex + 1}/${incidenciasSeleccionadas.length})`;
    document.getElementById('nombreUsuarioActualAlerta').textContent = nombreCompletoUsuario;
    
    document.getElementById('modalIncTitulo').textContent = inc.data.titulo;
    document.getElementById('modalIncItem').textContent = `Item asociado`;
    
    // Badges de tipo y severidad
    const badgeTipo = document.getElementById('modalIncTipo');
    badgeTipo.className = 'badge px-3 py-2';
    if (inc.data.tipo === 'critica') {
        badgeTipo.className += ' bg-danger';
        badgeTipo.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>CRÍTICA';
    } else if (inc.data.tipo === 'mayor') {
        badgeTipo.className += ' bg-warning text-dark';
        badgeTipo.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>MAYOR';
    } else {
        badgeTipo.className += ' bg-info';
        badgeTipo.innerHTML = '<i class="fas fa-info-circle me-1"></i>MENOR';
    }
    
    const badgeSeveridad = document.getElementById('modalIncSeveridad');
    badgeSeveridad.className = 'badge px-3 py-2';
    if (inc.data.severidad === 'alta') {
        badgeSeveridad.className += ' bg-danger';
        badgeSeveridad.innerHTML = '<i class="fas fa-arrow-up me-1"></i>ALTA';
    } else if (inc.data.severidad === 'media') {
        badgeSeveridad.className += ' bg-warning text-dark';
        badgeSeveridad.innerHTML = '<i class="fas fa-minus me-1"></i>MEDIA';
    } else {
        badgeSeveridad.className += ' bg-success';
        badgeSeveridad.innerHTML = '<i class="fas fa-arrow-down me-1"></i>BAJA';
    }
    
    // Limpiar formulario
    document.getElementById('comentarioResolucionAlerta').value = '';
    document.getElementById('imagenPruebaAlerta').value = '';
    document.getElementById('imagePreviewAlerta').style.display = 'none';
    document.getElementById('errorMensajeAlerta').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('modalResolverIncidenciaAlerta'));
    modal.show();
}

// Preview de imagen
document.getElementById('imagenPruebaAlerta').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            alert('⚠️ La imagen no debe superar los 5MB');
            this.value = '';
            document.getElementById('imagePreviewAlerta').style.display = 'none';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImgAlerta').src = e.target.result;
            document.getElementById('imagePreviewAlerta').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('imagePreviewAlerta').style.display = 'none';
    }
});

function confirmarResolucionIncidenciaAlerta() {
    const comentario = document.getElementById('comentarioResolucionAlerta').value.trim();
    const input = document.getElementById('imagenPruebaAlerta');
    const errorDiv = document.getElementById('errorMensajeAlerta');
    const errorTexto = document.getElementById('errorTextoAlerta');
    
    // Ocultar error previo
    errorDiv.style.display = 'none';
    
    if (!comentario || comentario.length < 10) {
        errorTexto.textContent = 'Debe ingresar un comentario de al menos 10 caracteres';
        errorDiv.style.display = 'block';
        document.getElementById('comentarioResolucionAlerta').focus();
        return;
    }
    
    if (!input.files || input.files.length === 0) {
        errorTexto.textContent = 'Debe seleccionar una imagen como prueba de resolución';
        errorDiv.style.display = 'block';
        return;
    }
    
    const archivo = input.files[0];
    
    const tiposPermitidos = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!tiposPermitidos.includes(archivo.type)) {
        errorTexto.textContent = 'Formato no válido. Use: PNG, JPG, JPEG, GIF o WEBP';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (archivo.size > 5 * 1024 * 1024) {
        errorTexto.textContent = 'La imagen no debe superar los 5MB';
        errorDiv.style.display = 'block';
        return;
    }
    
    const formData = new FormData();
    formData.append('imagen_prueba', archivo);
    formData.append('comentario_resolucion', comentario);
    
    // ✅ CORRECCIÓN: Obtener el botón correctamente
    const btn = document.querySelector('#modalResolverIncidenciaAlerta .btn-success');
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
    
    const incActual = incidenciasSeleccionadas[incidenciaActualIndex];
    
    fetch(`/incidencias/${incActual.id}/resolver`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            incidenciaActualIndex++;
            
            if (incidenciaActualIndex < incidenciasSeleccionadas.length) {
                // Hay más incidencias por resolver
                bootstrap.Modal.getInstance(document.getElementById('modalResolverIncidenciaAlerta')).hide();
                setTimeout(() => abrirModalResolucionIncidencia(), 300);
            } else {
                // Todas resueltas, ahora resolver la alerta
                bootstrap.Modal.getInstance(document.getElementById('modalResolverIncidenciaAlerta')).hide();
                resolverAlertaFinal();
            }
        } else {
            errorTexto.textContent = data.error || 'Error al resolver la incidencia';
            errorDiv.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        errorTexto.textContent = 'Error de conexión. Intente nuevamente.';
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}

function resolverAlertaFinal() {
    const incidenciasIds = incidenciasSeleccionadas.map(inc => inc.id);
    
    fetch(`/alerta/${alertaIdActual}/resolver`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({incidencias_ids: incidenciasIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ ${incidenciasIds.length} incidencia(s) resuelta(s) correctamente. La alerta ha sido actualizada.`);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'No se pudo resolver la alerta'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión al resolver la alerta');
    });
}

function resolverAlertaSinIncidencias() {
    fetch(`/alerta/${alertaIdActual}/resolver`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({incidencias_ids: []})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Alerta resuelta manualmente');
            bootstrap.Modal.getInstance(document.getElementById('modalResolverAlerta')).hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'No se pudo resolver la alerta'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión al resolver la alerta');
    });
}

function cancelarResolucionIncidencia() {
    if (confirm('¿Está seguro de cancelar? Se perderá el progreso de las incidencias resueltas.')) {
        bootstrap.Modal.getInstance(document.getElementById('modalResolverIncidenciaAlerta')).hide();
        location.reload();
    }
}

function resolverAlertaDirecto(alertaId) {
    if (confirm('¿Confirma que esta alerta ha sido atendida y resuelta correctamente?')) {
        fetch(`/alerta/${alertaId}/resolver`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({incidencias_ids: []})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Alerta resuelta correctamente');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'No se pudo resolver la alerta'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al resolver la alerta');
        });
    }
}
</script>
{% endblock %}